# GTFSãƒ•ã‚¡ã‚¤ãƒ«åã®çµ±ä¸€ã¨æœ¬ç•ªç’°å¢ƒã§ã®ä¸ƒãƒ¶æµœç”ºãƒã‚¹è¡¨ç¤ºå•é¡Œã®ä¿®æ­£

## ğŸ› å ±å‘Šã•ã‚ŒãŸå•é¡Œ

**ç—‡çŠ¶**: æœ¬ç•ªç’°å¢ƒã ã‘ä¸ƒãƒ¶æµœç”ºã®ãƒã‚¹ãŒæ¤œç´¢ãƒ«ãƒ¼ãƒˆã«å‡ºã¦ã“ãªã„

**åŸå› **: GTFSãƒ•ã‚¡ã‚¤ãƒ«åã®ä¸ä¸€è‡´

---

## ğŸ” å•é¡Œã®è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«åã®ä¸ä¸€è‡´

**ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** (`server/scripts/downloadGtfs.js`):
- ä»™å°å¸‚å–¶ãƒã‚¹: `sendai_bus.zip`
- ä¸ƒãƒ¶æµœç”ºãã‚‹ã‚Šã‚“ã“: `shichigahama_gururinko.zip`

**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«** (`server/utils/config.js`) - ä¿®æ­£å‰:
- ä»™å°å¸‚å–¶ãƒã‚¹: `gtfs-jp_sendaicitybus_current_date.zip` âŒ
- ä¸ƒãƒ¶æµœç”ºãã‚‹ã‚Šã‚“ã“: `All_Gururinko-20250225.zip` âŒ

### ãªãœæœ¬ç•ªç’°å¢ƒã ã‘å•é¡ŒãŒç™ºç”Ÿã—ãŸã®ã‹

1. **ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ**:
   - æ‰‹å‹•ã§GTFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ã„ãŸ
   - ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤ã„åå‰ (`All_Gururinko-20250225.zip`) ã®ã¾ã¾
   - config.jsã®è¨­å®šã¨ä¸€è‡´ã—ã¦ã„ãŸãŸã‚å•é¡Œãªã—

2. **æœ¬ç•ªç’°å¢ƒï¼ˆRenderï¼‰**:
   - `npm run download-gtfs` ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `shichigahama_gururinko.zip`
   - config.jsã§å‚ç…§ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã¯ `All_Gururinko-20250225.zip`
   - **ãƒ•ã‚¡ã‚¤ãƒ«åãŒä¸€è‡´ã—ãªã„ãŸã‚ã€ä¸ƒãƒ¶æµœç”ºã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œãªã„** âŒ

---

## âœ… ä¿®æ­£å†…å®¹

### 1. config.js ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’çµ±ä¸€

**`server/utils/config.js`**
```javascript
// Before
export const gtfsConfig = {
  agencies: [
    {
      // ä»™å°å¸‚å–¶ãƒã‚¹
      path: join(__dirname, '../gtfs_data/gtfs-jp_sendaicitybus_current_date.zip')
    },
    {
      // ä¸ƒãƒ¶æµœç”ºæ°‘ãƒã‚¹ã€Œãã‚‹ã‚Šã‚“ã“ã€
      path: join(__dirname, '../gtfs_data/All_Gururinko-20250225.zip')
    }
  ],
  // ...
};

// After
export const gtfsConfig = {
  agencies: [
    {
      // ä»™å°å¸‚å–¶ãƒã‚¹
      path: join(__dirname, '../gtfs_data/sendai_bus.zip')
    },
    {
      // ä¸ƒãƒ¶æµœç”ºæ°‘ãƒã‚¹ã€Œãã‚‹ã‚Šã‚“ã“ã€
      path: join(__dirname, '../gtfs_data/shichigahama_gururinko.zip')
    }
  ],
  // ...
};
```

**å¤‰æ›´ç‚¹**:
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã«çµ±ä¸€
- ã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ•ã‚¡ã‚¤ãƒ«åã«å¤‰æ›´

---

### 2. CLAUDE.md ã®æ‰‹é †ã‚’æ›´æ–°

**A. GTFSãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ‰‹é †**
```bash
# æ–¹æ³•1: è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰
cd server
npm run download-gtfs    # GTFSãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
npm run import-gtfs      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

# æ–¹æ³•2: æ‰‹å‹•ã§é…ç½®ã™ã‚‹å ´åˆ
# 1. server/gtfs_data/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®:
#    - sendai_bus.zip (ä»™å°å¸‚å–¶ãƒã‚¹)
#    - shichigahama_gururinko.zip (ä¸ƒãƒ¶æµœç”ºãã‚‹ã‚Šã‚“ã“)
# 2. npm run import-gtfs ã‚’å®Ÿè¡Œ
```

**B. Renderã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †**
```bash
5. GTFSãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
   ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€Render Shellã§å®Ÿè¡Œï¼š

   cd server
   npm run download-gtfs    # GTFSãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   npm run import-gtfs      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

   é‡è¦: ä¸¡æ–¹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
   download-gtfsã‚’å®Ÿè¡Œã—ãªã„ã¨ã€ä¸ƒãƒ¶æµœç”ºã®ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã›ã‚“ã€‚
```

---

## ğŸ“Š å¤‰æ›´çµ±è¨ˆ

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«: 2å€‹

#### 1. `server/utils/config.js`
**å¤‰æ›´è¡Œ**: Line 23, 27
- `gtfs-jp_sendaicitybus_current_date.zip` â†’ `sendai_bus.zip`
- `All_Gururinko-20250225.zip` â†’ `shichigahama_gururinko.zip`

#### 2. `CLAUDE.md`
**å¤‰æ›´ç®‡æ‰€**:
- GTFSãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ‰‹é †ã‚’æ›´æ–°
- Renderãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 
- æ³¨æ„æ›¸ãã‚’è¿½åŠ 

---

## ğŸ¯ æœ¬ç•ªç’°å¢ƒã§ã®å¯¾å¿œæ‰‹é †

### Renderã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰

1. **Render Shellã‚’é–‹ã**
   - Renderãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ ã‚ãªãŸã®ã‚µãƒ¼ãƒ“ã‚¹ â†’ "Shell" ã‚¿ãƒ–

2. **GTFSãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰**
   ```bash
   cd server
   npm run download-gtfs
   ```

3. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ**
   ```bash
   npm run import-gtfs
   ```

4. **ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•**
   - Renderãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â†’ "Manual Deploy" â†’ "Deploy latest commit"
   - ã¾ãŸã¯è‡ªå‹•çš„ã«å†èµ·å‹•ã•ã‚Œã‚‹

5. **å‹•ä½œç¢ºèª**
   ```bash
   # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
   curl https://your-app.onrender.com/api/health

   # ä¸ƒãƒ¶æµœç”ºå‘¨è¾ºã®åœç•™æ‰€æ¤œç´¢
   curl "https://your-app.onrender.com/api/gtfs/stops/nearby?lat=38.2983&lon=141.0606&radius=1.0"
   ```

---

## ğŸ”§ æŠ€è¡“çš„ãªè©³ç´°

### ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•ä½œ

**`server/scripts/downloadGtfs.js`**
```javascript
const GTFS_SOURCES = [
  {
    name: 'ä»™å°å¸‚å–¶ãƒã‚¹',
    id: 'sendai_bus',
    url: 'https://miyagi.dataeye.jp/dataset/.../sendai_bus.zip',
    filename: 'sendai_bus.zip'  // â† ã“ã®åå‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
  },
  {
    name: 'ä¸ƒãƒ¶æµœç”ºæ°‘ãƒã‚¹ã€Œãã‚‹ã‚Šã‚“ã“ã€',
    id: 'shichigahama_gururinko',
    url: 'https://ckan.odpt.org/dataset/.../shichigahama_town_all_gururinko.zip',
    filename: 'shichigahama_gururinko.zip'  // â† ã“ã®åå‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
  }
];
```

### ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•ä½œ

**`server/scripts/importGtfs.js`**
```javascript
import { importGtfs } from 'gtfs';
import { gtfsConfig } from '../utils/config.js';

async function runImport() {
  // gtfsConfigã§æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  await importGtfs(gtfsConfig);
}
```

**`server/utils/config.js`**
```javascript
export const gtfsConfig = {
  agencies: [
    {
      path: join(__dirname, '../gtfs_data/sendai_bus.zip')  // â† ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦
    },
    {
      path: join(__dirname, '../gtfs_data/shichigahama_gururinko.zip')  // â† ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¿…è¦
    }
  ],
  sqlitePath: join(__dirname, '../gtfs_data/gtfs.db'),
  ignoreDuplicates: true
};
```

### ãƒ•ã‚¡ã‚¤ãƒ«åçµ±ä¸€ã®ãƒ¡ãƒªãƒƒãƒˆ

1. **ä¸€è²«æ€§**: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰â†’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æµã‚ŒãŒã‚¹ãƒ ãƒ¼ã‚º
2. **ä¿å®ˆæ€§**: ãƒ•ã‚¡ã‚¤ãƒ«åãŒã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„
3. **å†ç¾æ€§**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚æœ¬ç•ªã§ã‚‚åŒã˜æ‰‹é †ã§å‹•ä½œ
4. **è‡ªå‹•åŒ–**: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã ã‘ã§å®Œçµ

---

## âœ… å‹•ä½œç¢ºèªãƒã‚¤ãƒ³ãƒˆ

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ç¢ºèª

1. [ ] å¤ã„GTFSãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
   ```bash
   cd server/gtfs_data
   rm -f gtfs-jp_sendaicitybus_current_date.zip
   rm -f All_Gururinko-20250225.zip
   rm -f gtfs.db
   ```

2. [ ] GTFSãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   ```bash
   cd server
   npm run download-gtfs
   ```

3. [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
   ```bash
   ls -lh gtfs_data/
   # sendai_bus.zip
   # shichigahama_gururinko.zip
   ```

4. [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
   ```bash
   npm run import-gtfs
   ```

5. [ ] ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
   ```bash
   npm start
   ```

6. [ ] ä¸ƒãƒ¶æµœç”ºå‘¨è¾ºã®åœç•™æ‰€ã‚’æ¤œç´¢
   ```bash
   curl "http://localhost:3001/api/gtfs/stops/nearby?lat=38.2983&lon=141.0606&radius=1.0"
   ```

7. [ ] æ¤œç´¢çµæœã«ä¸ƒãƒ¶æµœç”ºã®ãƒã‚¹åœãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

1. [ ] Render Shellã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ
2. [ ] ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
3. [ ] APIã§ä¸ƒãƒ¶æµœç”ºå‘¨è¾ºã®åœç•™æ‰€ã‚’æ¤œç´¢
4. [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä¸ƒãƒ¶æµœç”ºå‘¨è¾ºã®ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆ
5. [ ] ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã€Œãã‚‹ã‚Šã‚“ã“ã€ãƒã‚¹ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«åã®å¤‰æ›´å±¥æ­´

### æ—§ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ä»£ï¼‰
- `gtfs-jp_sendaicitybus_current_date.zip`
- `All_Gururinko-20250225.zip`

### æ–°ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆè‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰
- `sendai_bus.zip`
- `shichigahama_gururinko.zip`

**ç†ç”±**:
- æ—¥ä»˜ã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’å‰Šé™¤ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«
- è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ•´åˆæ€§
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã®å‘ä¸Š

---

## âœ… å®Œäº†ç¢ºèª

- [x] config.jsã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿®æ­£
- [x] CLAUDE.mdã®æ‰‹é †ã‚’æ›´æ–°
- [x] ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ•´åˆæ€§ã‚’ç¢ºèª
- [x] æœ¬ç•ªç’°å¢ƒã§ã®å¯¾å¿œæ‰‹é †ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

---

ä»¥ä¸Šã€GTFSãƒ•ã‚¡ã‚¤ãƒ«åã®çµ±ä¸€ã«ã‚ˆã‚Šã€æœ¬ç•ªç’°å¢ƒã§ã‚‚ä¸ƒãƒ¶æµœç”ºã®ãƒã‚¹ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

**æœ¬ç•ªç’°å¢ƒã§å¿…è¦ãªä½œæ¥­**:
1. Render Shellã§ `npm run download-gtfs`
2. Render Shellã§ `npm run import-gtfs`
3. ã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•

ã“ã‚Œã§ä¸ƒãƒ¶æµœç”ºã®ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ãã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚
